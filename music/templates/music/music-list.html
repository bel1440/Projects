{% extends 'music/music.html' %}
{% load static %}

{% block content-right %}
<!-- –°–ø–∏—Å–æ–∫ –ø–µ—Å–µ–Ω -->
<div class="songs">
    {% for song in Songss %}
    <div class="player" id="player{{ forloop.counter }}">
        <div class="cover">
            <img src="{% static 'music/img/music.jpg' %}" alt="Cover" />
        </div>
        <div class="info">
            <a href="{% url 'music-delete' song.id %}" class="btn btn-danger">
                <img src="{% static 'music/img/delete.png' %}" alt="–£–¥–∞–ª–∏—Ç—å">
            </a>
            <a href="{% url 'music-update' song.id %}" class="btn btn-info">
                <img src="{% static 'music/img/update.svg' %}" alt="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
            </a>
            <h3>{{ song.name_song }}</h3>
            <!-- –¢–æ–ª—å–∫–æ –∫–Ω–æ–ø–∫–∞ –ø–ª–µ–π -->
            <button class="play-btn" data-index="{{ forloop.counter }}" data-name="{{ song.name_song }}" data-url="{{ song.file.url }}">
                <img src="{% static 'music/img/play.png' %}" alt="<>">
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<!-- –ù–∏–∂–Ω–∏–π –∫—Ä–∞—Å–∏–≤—ã–π –ø–ª–µ–µ—Ä -->
<div id="bottomPlayerContainer" style="display: none; position: fixed; bottom: 0; left: 0; width: 100%; background-color: black; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); z-index: 9999;">
    <div class="bottom-player" style="display:flex; flex-direction:column; align-items:center;">
        <div style="display:flex; width:100%; align-items:center; justify-content: space-between;">
            <div class="cover" style="display:flex; flex-direction: row;">
                <img src="{% static 'music/img/music.jpg' %}" alt="Cover" id="bottomCover" style="width:60px; height:60px; object-fit:cover;" />
                <h3 id="bottomSongName" style="color:#FFFFFF;">–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Å–Ω—é</h3>
            </div>
            <div style="position: fixed; display: flex; flex-direction: column; margin-left: 455px;">
                <!-- –ö–æ–Ω—Ç—Ä–æ–ª—å -->
                <section class="controls" style="display:flex; justify-content:center;">
                    <!-- –ü–µ—Ä–µ–º–æ—Ç–∫–∞ –Ω–∞–∑–∞–¥ -->
                    <button class="btn btn-controls" id="back10" style="padding:8px; background-color: #e6e6e6; border-radius: 40px;">
                        <img src="{% static 'music/img/peremotka_nazad.png' %}" alt="<">
                    </button>
                    <!-- –ü–∞—É–∑–∞/–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ -->
                    <button class="btn btn-controls" id="playPause" style="padding:8px; background-color: #e6e6e6; border-radius: 40px;">
                        <img src="{% static 'music/img/play.png' %}" alt="<>">
                    </button>
                    <!-- –ü–µ—Ä–µ–º–æ—Ç–∫–∞ –≤–ø–µ—Ä–µ–¥ -->
                    <button class="btn btn-controls" id="forward10" style="padding:8px; background-color: #e6e6e6; border-radius: 40px;">
                        <img src="{% static 'music/img/peremotka_vpered.png' %}" alt=">">
                    </button>
                </section>
                <section class="section-seekbar" style="display: flex; align-items:center; width: 600px">
                        <span id="bottomCurrentTime" style="color:#fff; margin-right: 10px;">0:00</span>
                        <input type="range" id="bottomSeekBar" min="0" max="100" value="0" style="width: 100%;" />
                        <span id="bottomDuration" style="color:#fff; margin-left: 10px;">0:00</span>
                </section>
            </div>
                <!-- –ì—Ä–æ–º–∫–æ—Å—Ç—å –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–±–∞—Ä -->
            <div style="display:flex; align-items:center; ">
                    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å–±–∞—Ä -->
                    <section class="section-volumebar" style="display:flex; align-items: center;">
                        üîä
                        <input type="range" id="bottomVolume" min="0" max="1" step="0.01" value="0.2" style="width:150px;" />
                    </section>
            </div>
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const bottomContainer = document.getElementById('bottomPlayerContainer');
    const audioEl = document.getElementById('bottomAudio') || (() => {
        const a = document.createElement('audio');
        a.id='bottomAudio';
        a.preload='metadata';
        a.style.display='none';
        document.querySelector('.bottom-player').appendChild(a);
        return a;
    })();

    const bottomSeekBar = document.getElementById('bottomSeekBar');
    const bottomVolume = document.getElementById('bottomVolume');
    const bottomCurrentTime = document.getElementById('bottomCurrentTime');
    const bottomDuration = document.getElementById('bottomDuration');
    const bottomSongName = document.getElementById('bottomSongName');
    const bottomCover = document.getElementById('bottomCover');

    const playPauseBtn = document.getElementById('playPause');
    const back10Btn = document.getElementById('back10');
    const forward10Btn = document.getElementById('forward10');

    let isPlaying= false;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ –ø–µ—Å–Ω–∏ (–æ—Å—Ç–∞–≤—å—Ç–µ –∫–∞–∫ –µ—Å—Ç—å)
    document.querySelectorAll('.play-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const index= btn.dataset.index;
            const songName= btn.dataset.name;
            const songUrl= btn.dataset.url;

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–ª–µ–µ—Ä —Å–Ω–∏–∑—É
            bottomSongName.textContent= songName;
            audioEl.src= songUrl;
            audioEl.play();
            isPlaying= true;
            playPauseBtn.textContent='‚è∏';

            if (bottomContainer.style.display==='none') {
                bottomContainer.style.display='block';
            }
        });
    });

    // –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    audioEl.addEventListener('loadedmetadata', () => {
        bottomSeekBar.max= Math.floor(audioEl.duration);
        bottomDuration.textContent= formatTime(audioEl.duration);
        bottomSeekBar.value=0;
        bottomCurrentTime.textContent='0:00';
        updateProgress();
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    audioEl.addEventListener('timeupdate', () => {
        if (!isNaN(audioEl.duration)) {
            bottomSeekBar.value= Math.floor(audioEl.currentTime);
            bottomCurrentTime.textContent= formatTime(audioEl.currentTime);
            const progressPercent= (audioEl.currentTime / audioEl.duration) *100 ;
            bottomSeekBar.style.background= `linear-gradient(to right, #00f ${progressPercent}%, #555 ${progressPercent}%)`;
        }
    });

    // –ü–µ—Ä–µ–º–æ—Ç–∫–∞ –ø–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–±–∞—Ä—É
    bottomSeekBar.addEventListener('input', () => {
        if (!isNaN(audioEl.duration)) {
            audioEl.currentTime= bottomSeekBar.value;
        }
    });

    // –†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏
    bottomVolume.addEventListener('input', () => {
        audioEl.volume= parseFloat(bottomVolume.value);
    });

    // –ö–Ω–æ–ø–∫–∞ –ø–∞—É–∑—ã/–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è
    playPauseBtn.addEventListener('click', () => {
        if (audioEl.paused) {
            audioEl.play();
            isPlaying=true;
            playPauseBtn.textContent='‚è∏';
        } else {
            audioEl.pause();
            isPlaying=false;
            playPauseBtn.textContent='‚ñ∂';
        }
    });

    // –ü–µ—Ä–µ–º–æ—Ç–∫–∞ –Ω–∞–∑–∞–¥ –Ω–∞ 10 —Å–µ–∫—É–Ω–¥
    back10Btn.addEventListener('click', () => {
        if (!isNaN(audioEl.currentTime)) {
            audioEl.currentTime=Math.max(0, audioEl.currentTime -10);
        }
     });

     // –ü–µ—Ä–µ–º–æ—Ç–∫–∞ –≤–ø–µ—Ä–µ–¥ –Ω–∞ 10 —Å–µ–∫—É–Ω–¥
     forward10Btn.addEventListener('click', () => {
         if (!isNaN(audioEl.currentTime)) {
             audioEl.currentTime=Math.min(audioEl.duration, audioEl.currentTime +10);
         }
     });

     function formatTime(seconds) {
         const min= Math.floor(seconds/60);
         const sec= Math.floor(seconds%60);
         return `${min}:${sec.toString().padStart(2,'0')}`;
     }

     function updateProgress() {
         if (!isNaN(audioEl.duration)) {
             bottomSeekBar.max= Math.floor(audioEl.duration);
             bottomDuration.textContent= formatTime(audioEl.duration);
             bottomCurrentTime.textContent= formatTime(audioEl.currentTime);
         }
     }
});
</script>
{% endblock %}