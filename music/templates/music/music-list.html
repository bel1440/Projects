{% extends 'music/music.html' %}
{% load static %}

{% block content-right %}
<!-- Список песен -->
<div class="songs">
    {% for song in Songss %}
    <div class="player" id="player{{ forloop.counter }}">
        <div class="cover">
            <img src="{% static 'music/img/music.jpg' %}" alt="Cover" />
        </div>
        <div class="info">
            <a href="{% url 'music-delete' song.id %}" class="btn btn-danger">
                <img src="{% static 'music/img/delete.png' %}" alt="Удалить">
            </a>
            <a href="{% url 'music-update' song.id %}" class="btn btn-info">
                <img src="{% static 'music/img/update.svg' %}" alt="Редактировать">
            </a>
            <h3>{{ song.name_song }}</h3>
            <!-- Только кнопка плей -->
            <button class="play-btn" data-index="{{ forloop.counter }}" data-name="{{ song.name_song }}" data-url="{{ song.file.url }}">
                <img src="{% static 'music/img/play.png' %}" alt="<>">
            </button>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Нижний красивый плеер -->
<div id="bottomPlayerContainer" style="display: none; position: fixed; bottom: 0; left: 0; width: 100%; background-color: black; padding: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.3); z-index: 9999;">
    <div class="bottom-player" style="display:flex; flex-direction:column; align-items:center;">
        <div style="display:flex; width:100%; align-items:center; justify-content: space-between;">
            <div class="cover" style="display:flex; flex-direction: row; align-items: center; min-width: 300px;">
                <img src="{% static 'music/img/music.jpg' %}" alt="Cover" id="bottomCover" style="width:60px; height:60px; object-fit:cover;" />
                <h3 id="bottomSongName" style="color:#FFFFFF; margin-left: 10px;">Выберите песню</h3>
            </div>
            <div style="display: flex; flex-direction: column; width: 60%;">
                <!-- Контроль -->
                <section class="controls" style="display:flex; justify-content:center; margin-bottom: 10px;">
                    <!-- Перемотка назад -->
                    <button class="btn btn-controls" id="back10" style="padding:8px; background-color: #e6e6e6; border-radius: 40px; margin: 0 5px;">
                        <img src="{% static 'music/img/peremotka_nazad.png' %}" alt="<">
                    </button>
                    <!-- Пауза/Воспроизведение -->
                    <button class="btn btn-controls" id="playPause" style="padding:8px; background-color: #e6e6e6; border-radius: 40px; margin: 0 5px;">
                        <img src="{% static 'music/img/play.png' %}" alt="<>" id="playPauseIcon">
                    </button>
                    <!-- Перемотка вперед -->
                    <button class="btn btn-controls" id="forward10" style="padding:8px; background-color: #e6e6e6; border-radius: 40px; margin: 0 5px;">
                        <img src="{% static 'music/img/peremotka_vpered.png' %}" alt=">">
                    </button>
                </section>
                <section class="section-seekbar" style="display: flex; align-items:center; width: 100%">
                    <span id="bottomCurrentTime" style="color:#fff; margin-right: 10px; min-width: 40px;">0:00</span>
                    <input type="range" id="bottomSeekBar" min="0" max="100" value="0" style="width: 100%;" />
                    <span id="bottomDuration" style="color:#fff; margin-left: 10px; min-width: 40px;">0:00</span>
                </section>
            </div>
            <!-- Громкость и прогрессбар -->
            <div style="display:flex; align-items:center; min-width: 200px; margin-left: 20px;">
                <!-- Прогрессбар -->
                <section class="section-volumebar" style="display:flex; align-items: center; width: 100%;">
                    <img src="{% static 'music/img/volume.png' %}" alt="Volume" style="width:20px; margin-right: 5px;">
                    <input type="range" id="bottomVolume" min="0" max="100" step="1" value="20" style="width:100%;" />
                </section>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const bottomContainer = document.getElementById('bottomPlayerContainer');
    const audioEl = document.getElementById('bottomAudio') || (() => {
        const a = document.createElement('audio');
        a.id = 'bottomAudio';
        a.preload = 'metadata';
        a.style.display = 'none';
        document.querySelector('.bottom-player').appendChild(a);
        return a;
    })();

    const bottomSeekBar = document.getElementById('bottomSeekBar');
    const bottomVolume = document.getElementById('bottomVolume');
    const bottomCurrentTime = document.getElementById('bottomCurrentTime');
    const bottomDuration = document.getElementById('bottomDuration');
    const bottomSongName = document.getElementById('bottomSongName');
    const bottomCover = document.getElementById('bottomCover');
    const playPauseBtn = document.getElementById('playPause');
    const playPauseIcon = document.getElementById('playPauseIcon');
    const back10Btn = document.getElementById('back10');
    const forward10Btn = document.getElementById('forward10');

    let isPlaying = false;
    let isSeeking = false;

    // Массив с песнями
    const songs = [
        {% for song in Songss %}
        {
            name: "{{ song.name_song|escapejs }}",
            url: "{{ song.file.url|escapejs }}",
            cover: "{% static 'music/img/music.jpg' %}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    let currentIndex = -1;

    // Функция для воспроизведения песни по индексу
    function playSong(index) {
        if (index < 0 || index >= songs.length) return;

        currentIndex = index;
        const song = songs[index];

        bottomSongName.textContent = song.name;
        audioEl.src = song.url;
        bottomCover.src = song.cover;

        audioEl.play().then(() => {
            isPlaying = true;
            playPauseIcon.src = "{% static 'music/img/pause.png' %}";

            if (bottomContainer.style.display === 'none') {
                bottomContainer.style.display = 'block';
            }
        }).catch(error => {
            console.error("Ошибка воспроизведения:", error);
        });
    }

    // Обработчик выбора песни
    document.querySelectorAll('.play-btn').forEach((btn, index) => {
        btn.addEventListener('click', () => {
            playSong(parseInt(btn.dataset.index) - 1);
        });
    });

    // Обработка окончания трека
    audioEl.addEventListener('ended', () => {
        if (currentIndex + 1 < songs.length) {
            playSong(currentIndex + 1);
        } else {
            isPlaying = false;
            playPauseIcon.src = "{% static 'music/img/play.png' %}";
        }
    });

    // Метаданные загружены
    audioEl.addEventListener('loadedmetadata', () => {
        bottomSeekBar.max = Math.floor(audioEl.duration);
        bottomDuration.textContent = formatTime(audioEl.duration);
        updateProgressBar();
        updateVolumeBar();
    });

    // Обновление прогресса
    audioEl.addEventListener('timeupdate', () => {
        if (!isSeeking && !isNaN(audioEl.duration)) {
            bottomSeekBar.value = audioEl.currentTime;
            bottomCurrentTime.textContent = formatTime(audioEl.currentTime);
            updateProgressBar();
        }
    });

    // Обработчики для перемотки
    bottomSeekBar.addEventListener('input', () => {
        isSeeking = true;
        bottomCurrentTime.textContent = formatTime(bottomSeekBar.value);
        updateProgressBar();
    });

    bottomSeekBar.addEventListener('change', () => {
        audioEl.currentTime = bottomSeekBar.value;
        isSeeking = false;
    });

    // Громкость
    bottomVolume.addEventListener('input', () => {
        audioEl.volume = bottomVolume.value / 100;
        updateVolumeBar();
    });

    // Кнопка паузы/воспроизведения
    playPauseBtn.addEventListener('click', () => {
        if (audioEl.paused) {
            audioEl.play().then(() => {
                isPlaying = true;
                playPauseIcon.src = "{% static 'music/img/pause.png' %}";
            });
        } else {
            audioEl.pause();
            isPlaying = false;
            playPauseIcon.src = "{% static 'music/img/play.png' %}";
        }
    });

    // Перемотка назад на 10 секунд
    back10Btn.addEventListener('click', () => {
        audioEl.currentTime = Math.max(0, audioEl.currentTime - 10);
    });

    // Перемотка вперед на 10 секунд
    forward10Btn.addEventListener('click', () => {
        audioEl.currentTime = Math.min(audioEl.duration, audioEl.currentTime + 10);
    });

    // Форматирование времени
    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min}:${sec.toString().padStart(2, '0')}`;
    }

    // Обновление прогресс-бара
    function updateProgressBar() {
        const progressPercent = (bottomSeekBar.value / bottomSeekBar.max) * 100;
        bottomSeekBar.style.background = `
            linear-gradient(to right, #FFFFFF ${progressPercent}%, #2c323d ${progressPercent}%)
        `;
    }

    // Обновление ползунка громкости
    function updateVolumeBar() {
        const volumePercent = bottomVolume.value;
        bottomVolume.style.background = `
            linear-gradient(to right, #FFFFFF ${volumePercent}%, #2c323d ${volumePercent}%)
        `;
    }

    // Инициализация громкости
    audioEl.volume = 0.2;
    updateVolumeBar();
});
</script>
{% endblock %}